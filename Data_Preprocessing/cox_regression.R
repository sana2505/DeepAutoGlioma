#2. Feature selection
##    a.Identification of biological relevant features
# Based on Z-score Differentially expressed genes and differentially methylated regions were identified
##                              ???????????????????????????=(???? ??-????)/????



##    b.Identification of clinical relevant features
# Identification of survival associated DEGs and survival associated DMRs
#Extraction of survival associated DEGs
#                   ????(????)=????_???? (???? )×???????????????????????????????{????_???? ????_????+ ????_???? ????_????+????????????????????????+????_???? ????_????}

#Extraction of survival associated DMRs
#                   ????(????)=????_???? (???? )×"??"??????????????????????????{????_???? ????_????+ ????_???? ????_????+????????????????????????+????_???? ????_????}


# Cox univarite regression analysis
setwd("C:/Users/Sazee/Desktop/")

library("survminer")
library(broom)
data_S <- read.csv('LGG_GE_data_4519_features_original_data_survival_data.csv', header = TRUE)

res.cox <- coxph(Surv(survival, status) ~ A1BG, data = data_S)
summary(res.cox)

##create a loop for individual genes
#res.cox <- coxph(Surv(survival, status) ~ ANXA2, data = data_S)
#summary(res.cox)


#out = tidy(res.cox)
#write.csv(out, file="res.cox_table_classical.csv")
data_S_x = data_S[5:3654]
covariates <- colnames(data_S_x) 
univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste('Surv(survival, status)~', x)))

univ_models <- lapply(univ_formulas, function(x){coxph(x, data = data_S)})
# Extract data 
univ_results <- lapply(univ_models,
                       function(x){ 
                         x <- summary(x)
                         p.value<-signif(x$wald["pvalue"], digits=2)
                         wald.test<-signif(x$wald["test"], digits=2)
                         beta<-signif(x$coef[1], digits=2);#coeficient beta
                         HR <-signif(x$coef[2], digits=2);#exp(beta)
                         HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                         HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                         HR <- paste0(HR, " (", 
                                      HR.confint.lower, "-", HR.confint.upper, ")")
                         res<-c(beta, HR, wald.test, p.value)
                         names(res)<-c("beta", "HR (95% CI for HR)", "wald.test", 
                                       "p.value")
                         return(res)
                         #return(exp(cbind(coef(x),confint(x))))
                       })
res <- t(as.data.frame(univ_results, check.names = FALSE))
as.data.frame(res)


write.csv(res, file="res_univariate_table_LGG_GE.csv")

